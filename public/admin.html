<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; connect-src 'self' https://nominatim.openstreetmap.org http://localhost:3006 http://127.0.0.1:3006 https://json-server-typescript-5.onrender.com; img-src 'self' data: https:;">
    <title>Administration - TransCargo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS et JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- CSS modulaire -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-ship"></i>
                <h1>TransCargo Admin</h1>
            </div>
            <nav class="nav">
                <a href="#accueil" class="nav-link active" data-section="accueil">
                    <i class="fas fa-home"></i> Accueil
                </a>
                <a href="#cargaisons" class="nav-link" data-section="cargaisons">
                    <i class="fas fa-boxes"></i> Cargaisons
                </a>
                <a href="#colis" class="nav-link" data-section="colis">
                    <i class="fas fa-box"></i> Nouveau Colis
                </a>
                <a href="#recherche" class="nav-link" data-section="recherche">
                    <i class="fas fa-search"></i> Recherche
                </a>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </button>
            </nav>
        </div>
    </header>

    <main class="main">
        <!-- Section Accueil -->
        <section id="accueil" class="section active">
            <div class="container">
                <div class="hero">
                    <h2>TransCargo - Administration</h2>
                    <p>Tableau de bord administrateur pour la gestion complète des cargaisons maritimes, aériennes et routières</p>
                </div>
                
                <div class="dashboard">
                    <h2><i class="fas fa-chart-line"></i> Tableau de Bord</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-boxes"></i>
                            <h3 id="total-cargaisons">0</h3>
                            <p>Cargaisons Actives</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-cube"></i>
                            <h3 id="total-colis">0</h3>
                            <p>Colis en Transit</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-euro-sign"></i>
                            <h3 id="revenus-total">0F</h3>
                            <p>Revenus Total</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-truck-loading"></i>
                            <h3 id="en-cours">0</h3>
                            <p>Livraisons en Cours</p>
                        </div>
                    </div>

                    <!-- Statistiques détaillées -->
                    <div class="detailed-stats" style="margin-top: 40px;">
                        <h3><i class="fas fa-chart-pie"></i> Statistiques Détaillées</h3>
                        
                        <div class="stats-section">
                            <h4><i class="fas fa-boxes"></i> État des Cargaisons</h4>
                            <div class="stats-grid">
                                <div class="stat-card secondary">
                                    <i class="fas fa-check-circle"></i>
                                    <h3 id="cargaisons-arrives">0</h3>
                                    <p>Cargaisons Arrivées</p>
                                </div>
                                <div class="stat-card secondary">
                                    <i class="fas fa-unlock"></i>
                                    <h3 id="cargaisons-ouvertes">0</h3>
                                    <p>Cargaisons Ouvertes</p>
                                </div>
                                <div class="stat-card secondary">
                                    <i class="fas fa-lock"></i>
                                    <h3 id="cargaisons-fermes">0</h3>
                                    <p>Cargaisons Fermées</p>
                                </div>
                            </div>
                        </div>

                        <div class="stats-section">
                            <h4><i class="fas fa-shipping-fast"></i> Types de Transport</h4>
                            <div class="stats-grid">
                                <div class="stat-card tertiary">
                                    <i class="fas fa-ship"></i>
                                    <h3 id="transport-maritime">0</h3>
                                    <p>Transport Maritime</p>
                                </div>
                                <div class="stat-card tertiary">
                                    <i class="fas fa-truck"></i>
                                    <h3 id="transport-routiere">0</h3>
                                    <p>Transport Routier</p>
                                </div>
                                <div class="stat-card tertiary">
                                    <i class="fas fa-plane"></i>
                                    <h3 id="transport-aerienne">0</h3>
                                    <p>Transport Aérien</p>
                                </div>
                            </div>
                        </div>

                        <div class="stats-section">
                            <h4><i class="fas fa-cube"></i> État des Colis</h4>
                            <div class="stats-grid">
                                <div class="stat-card success">
                                    <i class="fas fa-check"></i>
                                    <h3 id="colis-arrives">0</h3>
                                    <p>Colis Arrivés</p>
                                </div>
                                <div class="stat-card warning">
                                    <i class="fas fa-clock"></i>
                                    <h3 id="colis-attente">0</h3>
                                    <p>Colis en Attente</p>
                                </div>
                                <div class="stat-card danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <h3 id="colis-perdus">0</h3>
                                    <p>Colis Perdus</p>
                                </div>
                                <div class="stat-card info">
                                    <i class="fas fa-hand-holding"></i>
                                    <h3 id="colis-recuperes">0</h3>
                                    <p>Colis Récupérés</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Section Cargaisons -->
        <section id="cargaisons" class="section">
            <div class="container">
                <div class="form-section">
                    <h2><i class="fas fa-boxes"></i> Gestion des Cargaisons</h2>
                    
                    <h3><i class="fas fa-plus"></i> Créer une nouvelle cargaison</h3>
                    <form id="form-nouvelle-cargaison" class="form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="type-cargaison">Type de transport :</label>
                                <select id="type-cargaison" required>
                                    <option value="">Sélectionner...</option>
                                    <option value="maritime">Maritime</option>
                                    <option value="aerienne">Aérienne</option>
                                    <option value="routiere">Routière</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="poids-max">Poids maximum (kg) :</label>
                                <input type="number" id="poids-max" class="form-control" min="1" value="1000" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Lieu de départ :</label>
                                <div class="location-input">
                                    <input type="text" id="lieu-depart-display" class="form-control" readonly placeholder="Cliquez pour sélectionner sur la carte">
                                    <button type="button" id="btn-select-depart" class="btn btn-secondary" onclick="openLocationSelector('lieu-depart-display')">
                                        <i class="fas fa-map-marker-alt"></i> Sélectionner
                                    </button>
                                    <input type="hidden" id="lieu-depart-lat">
                                    <input type="hidden" id="lieu-depart-lng">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Lieu d'arrivée :</label>
                                <div class="location-input">
                                    <input type="text" id="lieu-arrivee-display" class="form-control" readonly placeholder="Cliquez pour sélectionner sur la carte">
                                    <button type="button" id="btn-select-arrivee" class="btn btn-secondary" onclick="openLocationSelector('lieu-arrivee-display')">
                                        <i class="fas fa-map-marker-alt"></i> Sélectionner
                                    </button>
                                    <input type="hidden" id="lieu-arrivee-lat">
                                    <input type="hidden" id="lieu-arrivee-lng">
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Créer la cargaison
                        </button>
                    </form>
                </div>

                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h3><i class="fas fa-list"></i> Cargaisons existantes</h3>
                        <div class="pagination-controls">
                            <label for="items-per-page">Afficher :</label>
                            <select id="items-per-page">
                                <option value="5">5 par page</option>
                                <option value="10" selected>10 par page</option>
                                <option value="15">15 par page</option>
                                <option value="20">20 par page</option>
                            </select>
                        </div>
                    </div>
                    <div id="liste-cargaisons" class="cards-grid">
                        <!-- Les cargaisons seront affichées ici -->
                    </div>
                    <div id="pagination-container" class="pagination-container">
                        <!-- Les contrôles de pagination seront affichés ici -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Section Nouveau Colis -->
        <section id="colis" class="section">
            <div class="container">
                <div class="form-section">
                    <h2><i class="fas fa-box"></i> Enregistrer un nouveau colis</h2>
                    
                    <form id="form-nouveau-colis" class="form">
                        <h4>Informations de l'expéditeur</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="exp-prenom">Prénom :</label>
                                <input type="text" id="exp-prenom" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="exp-nom">Nom :</label>
                                <input type="text" id="exp-nom" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="exp-telephone">Téléphone :</label>
                                <input type="tel" id="exp-telephone" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="exp-email">Email :</label>
                                <input type="email" id="exp-email" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="exp-adresse">Adresse :</label>
                            <textarea id="exp-adresse" required></textarea>
                        </div>

                        <h4>Informations du destinataire</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dest-nom">Nom complet :</label>
                                <input type="text" id="dest-nom" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="dest-telephone">Téléphone :</label>
                                <input type="tel" id="dest-telephone" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dest-email">Email :</label>
                                <input type="email" id="dest-email" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dest-adresse">Adresse :</label>
                            <textarea id="dest-adresse" required></textarea>
                        </div>

                        <h4>Informations du colis</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="colis-nombre">Nombre de colis :</label>
                                <input type="number" id="colis-nombre" class="form-control" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="colis-poids">Poids total (kg) :</label>
                                <input type="number" id="colis-poids" class="form-control" min="0.1" step="0.1" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="colis-type-produit">Type de produit :</label>
                                <select id="colis-type-produit" required>
                                    <option value="">Sélectionner...</option>
                                    <option value="alimentaire">Alimentaire</option>
                                    <option value="materiel-fragile">Matériel fragile</option>
                                    <option value="materiel-incassable">Matériel incassable</option>
                                    <option value="chimique">Chimique</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="colis-type-cargaison">Type de transport :</label>
                                <select id="colis-type-cargaison" required>
                                    <option value="">Sélectionner...</option>
                                    <option value="maritime">Maritime</option>
                                    <option value="aerienne">Aérienne</option>
                                    <option value="routiere">Routière</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="colis-cargaison">Cargaison disponible :</label>
                            <select id="colis-cargaison" class="form-control" required>
                                <option value="">-- Veuillez sélectionner une cargaison --</option>
                            </select>
                        </div>
                        <div id="cargaison-info" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 10px;">
                            <h5 style="margin-bottom: 10px; color: #495057;">Cargaisons disponibles :</h5>
                            <div id="cargaison-list"></div>
                        </div>

                        <button type="submit" id="btn-enregistrer-colis" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer le colis
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Section Recherche -->
        <section id="recherche" class="section">
            <div class="container">
                <div class="form-section">
                    <h2><i class="fas fa-search"></i> Recherche et Gestion</h2>
                    
                    <div class="search-tabs">
                        <button class="search-tab-button active" data-search-tab="colis-search">Recherche Colis</button>
                        <button class="search-tab-button" data-search-tab="cargaison-search">Recherche Cargaison</button>
                        <button class="search-tab-button" data-search-tab="colis-management">Gestion Colis</button>
                    </div>

                    <div id="colis-search" class="search-tab-content active">
                        <form id="form-recherche-colis" class="form">
                            <div class="form-group">
                                <label for="search-code-colis">Code du colis :</label>
                                <input type="text" id="search-code-colis" class="form-control" placeholder="Ex: COL-ABC123">
                            </div>
                            <button type="submit" class="btn btn-secondary">
                                <i class="fas fa-search"></i> Rechercher
                            </button>
                        </form>
                        <div id="resultat-colis" class="search-results"></div>
                    </div>

                    <div id="cargaison-search" class="search-tab-content">
                        <form id="form-recherche-cargaison" class="form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="search-code-cargaison">Code cargaison :</label>
                                    <input type="text" id="search-code-cargaison" class="form-control" placeholder="Ex: CG-ABC123">
                                </div>
                                <div class="form-group">
                                    <label for="search-type">Type :</label>
                                    <select id="search-type">
                                        <option value="">Tous</option>
                                        <option value="maritime">Maritime</option>
                                        <option value="aerienne">Aérienne</option>
                                        <option value="routiere">Routière</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="search-lieu-depart">Lieu de départ :</label>
                                    <input type="text" id="search-lieu-depart" class="form-control" placeholder="Ex: Dakar">
                                </div>
                                <div class="form-group">
                                    <label for="search-lieu-arrivee">Lieu d'arrivée :</label>
                                    <input type="text" id="search-lieu-arrivee" class="form-control" placeholder="Ex: Thiès">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="search-date-depart">Date de départ :</label>
                                    <input type="date" id="search-date-depart" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="search-date-arrivee">Date d'arrivée :</label>
                                    <input type="date" id="search-date-arrivee" class="form-control">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-secondary">
                                <i class="fas fa-search"></i> Rechercher
                            </button>
                        </form>
                        <div id="resultat-cargaison" class="search-results"></div>
                    </div>

                    <div id="colis-management" class="search-tab-content">
                        <h3><i class="fas fa-cogs"></i> Gestion des Colis</h3>
                        <form id="form-gestion-colis" class="form">
                            <div class="form-group">
                                <label for="gestion-code-colis">Code du colis à gérer :</label>
                                <input type="text" id="gestion-code-colis" class="form-control" placeholder="Ex: COL-ABC123 ou code destinataire" required>
                            </div>
                            <div class="management-actions">
                                <button type="button" class="btn btn-success" onclick="colisManager.recupererColis()">
                                    <i class="fas fa-check-circle"></i> Marquer Récupéré
                                </button>
                                <button type="button" class="btn btn-danger" onclick="colisManager.marquerPerdu()">
                                    <i class="fas fa-exclamation-triangle"></i> Marquer Perdu
                                </button>
                                <button type="button" class="btn btn-warning" onclick="colisManager.archiverColis()">
                                    <i class="fas fa-archive"></i> Archiver
                                </button>
                                <button type="button" class="btn btn-info" onclick="colisManager.afficherModalEtat()">
                                    <i class="fas fa-edit"></i> Changer État
                                </button>
                            </div>
                        </form>
                        <div id="resultat-gestion" class="search-results"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section Statistiques -->
        <section id="statistiques" class="section">
            <div class="container">
                <div class="form-section">
                    <div class="stats-grid" id="stats-grid">
                        <!-- Les statistiques seront affichées ici -->
                    </div>

                </div>
            </div>
        </section>
    </main>

    <!-- Modal pour la sélection de lieu -->
    <div id="map-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1000px; width: 95vw; max-height: 95vh; height: 90vh;">
            <span class="close" onclick="closeMapModal()">&times;</span>
            <h3 id="map-modal-title">Sélectionner un lieu sur la carte</h3>
            
            <!-- Champ de recherche -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="location-search" placeholder="🔍 Rechercher une ville, adresse..."
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                <button onclick="searchLocation()" style="margin-top: 8px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-search"></i> Rechercher
                </button>
            </div>
            
            <!-- Conteneur de la carte -->
            <div id="leaflet-map" style="height: 60vh; width: 100%; margin: 1rem 0; border: 2px solid #ddd; border-radius: 8px; z-index: 1;"></div>
            
            <!-- Informations sur le lieu sélectionné -->
            <div id="selected-location-info" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; display: none;">
                <strong>Lieu sélectionné :</strong> <span id="selected-location-text">Aucun lieu sélectionné</span>
            </div>
            
            <!-- Boutons d'action -->
            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn btn-primary" onclick="confirmLocationSelection()">
                    <i class="fas fa-check"></i> Confirmer la sélection
                </button>
                <button class="btn btn-secondary" onclick="closeMapModal()">
                    <i class="fas fa-times"></i> Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Modal principal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Modal pour changer l'état d'un colis -->
    <div id="modal-change-etat" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="modal-close" onclick="colisManager.fermerModalEtat()">&times;</button>
            <h3><i class="fas fa-edit"></i> Changer l'état du colis</h3>
            <form id="form-change-etat">
                <div class="form-group">
                    <label for="nouvel-etat">Nouvel état :</label>
                    <select id="nouvel-etat" class="form-control" required>
                        <option value="">Sélectionner un état...</option>
                        <option value="EN_ATTENTE">En attente</option>
                        <option value="EN_COURS">En cours</option>
                        <option value="ARRIVE">Arrivé</option>
                        <option value="RECUPERE">Récupéré</option>
                        <option value="PERDU">Perdu</option>
                        <option value="ARCHIVE">Archivé</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="commentaire-etat">Commentaire (optionnel) :</label>
                    <textarea id="commentaire-etat" class="form-control" rows="3" placeholder="Raison du changement d'état..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Confirmer
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="colisManager.fermerModalEtat()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts modulaires -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="map-functions.js"></script>
    
    <!-- Utilitaires - IMPORTANT: json-server-api en PREMIER -->
    <script src="js/utils/json-server-api.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/notifications.js"></script>
    <script src="js/utils/api.js"></script>
    <script src="js/utils/modals.js"></script>
    
    <!-- Modules -->
    <script src="js/modules/navigation.js"></script>
    <script src="js/modules/cargaisons.js"></script>
    
    <!-- Services -->
    <script src="js/services/app-initializer.js"></script>
    <script src="js/services/event-manager.js"></script>
    <script src="js/services/colis-action-manager.js"></script>
    <script src="js/services/colis-manager.js"></script>
    
    <!-- Composants -->
    <script src="js/components/cargaison-details.js"></script>
    
    <!-- Gestionnaires de formulaires -->
    <script src="js/forms/form-manager.js"></script>
    
    <!-- Application principale -->
    <script src="js/app.js"></script>
    
    <!-- Fonction de déconnexion globale -->
    <script>
        function logout() {
            localStorage.removeItem('gestionnaire_token');
            localStorage.removeItem('gestionnaire_user');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>