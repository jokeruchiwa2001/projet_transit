<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Ajout Colis avec Sélection Cargaison</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .cargaison-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .pricing-info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Test - Ajout de Colis avec Sélection de Cargaison</h1>
    
    <div class="pricing-info">
        <h3>Tarifs selon le tableau fourni:</h3>
        <ul>
            <li><strong>Alimentaire:</strong> Routière: 100F/kg/km, Maritime: 90F/kg/km + 5000F, Aérienne: 300F/kg/km</li>
            <li><strong>Chimique:</strong> Maritime uniquement: 500F/kg + 10000F entretien</li>
            <li><strong>Matériel:</strong> Routière: 200F/kg/km, Maritime: 400F/kg/km, Aérienne: 1000F/kg</li>
        </ul>
    </div>

    <form id="colisForm">
        <h2>Informations de l'expéditeur</h2>
        <div class="form-group">
            <label for="expNom">Nom:</label>
            <input type="text" id="expNom" name="expNom" required>
        </div>
        <div class="form-group">
            <label for="expPrenom">Prénom:</label>
            <input type="text" id="expPrenom" name="expPrenom" required>
        </div>
        <div class="form-group">
            <label for="expTelephone">Téléphone:</label>
            <input type="tel" id="expTelephone" name="expTelephone" required>
        </div>
        <div class="form-group">
            <label for="expAdresse">Adresse:</label>
            <textarea id="expAdresse" name="expAdresse" required></textarea>
        </div>

        <h2>Informations du destinataire</h2>
        <div class="form-group">
            <label for="destNom">Nom complet:</label>
            <input type="text" id="destNom" name="destNom" required>
        </div>
        <div class="form-group">
            <label for="destTelephone">Téléphone:</label>
            <input type="tel" id="destTelephone" name="destTelephone" required>
        </div>
        <div class="form-group">
            <label for="destAdresse">Adresse:</label>
            <textarea id="destAdresse" name="destAdresse" required></textarea>
        </div>

        <h2>Informations du colis</h2>
        <div class="form-group">
            <label for="poids">Poids (kg):</label>
            <input type="number" id="poids" name="poids" step="0.1" required>
        </div>
        <div class="form-group">
            <label for="typeProduit">Type de produit:</label>
            <select id="typeProduit" name="typeProduit" required onchange="updateCargaisonOptions()">
                <option value="">Sélectionner un type</option>
                <option value="alimentaire">Alimentaire</option>
                <option value="chimique">Chimique</option>
                <option value="materiel">Matériel</option>
            </select>
        </div>
        <div class="form-group">
            <label for="typeCargaison">Type de cargaison:</label>
            <select id="typeCargaison" name="typeCargaison" required onchange="loadCargaisons()">
                <option value="">Sélectionner un type</option>
                <option value="routiere">Routière</option>
                <option value="maritime">Maritime</option>
                <option value="aerienne">Aérienne</option>
            </select>
        </div>
        <div class="form-group">
            <label for="nombreColis">Nombre de colis:</label>
            <input type="number" id="nombreColis" name="nombreColis" min="1" value="1" required>
        </div>

        <h2>Sélection de la cargaison (OBLIGATOIRE)</h2>
        <div class="form-group">
            <label for="cargaisonId">Cargaison disponible: *</label>
            <select id="cargaisonId" name="cargaisonId" required>
                <option value="">-- Veuillez sélectionner une cargaison --</option>
            </select>
        </div>
        <div id="cargaisonInfo"></div>

        <button type="submit">Créer le colis</button>
    </form>

    <div id="result"></div>

    <script>
        const API_BASE = '/api';

        async function updateCargaisonOptions() {
            const typeProduit = document.getElementById('typeProduit').value;
            const typeCargaisonSelect = document.getElementById('typeCargaison');
            
            // Réinitialiser les options
            Array.from(typeCargaisonSelect.options).forEach(option => {
                option.disabled = false;
            });

            if (typeProduit === 'chimique') {
                // Désactiver routière et aérienne pour les produits chimiques
                Array.from(typeCargaisonSelect.options).forEach(option => {
                    if (option.value === 'routiere' || option.value === 'aerienne') {
                        option.disabled = true;
                    }
                });
                // Auto-sélectionner maritime
                typeCargaisonSelect.value = 'maritime';
                await loadCargaisons();
            }
        }

        async function loadCargaisons() {
            const typeCargaison = document.getElementById('typeCargaison').value;
            const cargaisonSelect = document.getElementById('cargaisonId');
            const cargaisonInfo = document.getElementById('cargaisonInfo');
            
            if (!typeCargaison) {
                cargaisonSelect.innerHTML = '<option value="">-- Veuillez sélectionner une cargaison --</option>';
                cargaisonInfo.innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/cargaisons/disponibles?type=${typeCargaison}`);
                const cargaisons = await response.json();
                
                // Réinitialiser les options
                cargaisonSelect.innerHTML = '<option value="">-- Veuillez sélectionner une cargaison --</option>';
                
                if (cargaisons.length === 0) {
                    cargaisonInfo.innerHTML = '<p class="error">Aucune cargaison disponible pour ce type de transport. Le gestionnaire doit d\'abord créer une cargaison ouverte.</p>';
                    return;
                }

                cargaisons.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = `${c.numero} - ${c.trajet.depart.lieu} → ${c.trajet.arrivee.lieu} (${c.poidsRestant}kg restant)`;
                    cargaisonSelect.appendChild(option);
                });

                // Afficher les informations des cargaisons
                cargaisonInfo.innerHTML = '<h3>Cargaisons disponibles:</h3>' +
                    cargaisons.map(c => `
                        <div class="cargaison-item">
                            <strong>${c.numero}</strong> - ${c.type.toUpperCase()}<br>
                            Trajet: ${c.trajet.depart.lieu} → ${c.trajet.arrivee.lieu} (${c.distance}km)<br>
                            Capacité: ${c.poidsUtilise}/${c.poidsMax}kg (${c.poidsRestant}kg restant)<br>
                            Colis: ${c.nbColis}
                        </div>
                    `).join('');

            } catch (error) {
                console.error('Erreur lors du chargement des cargaisons:', error);
                cargaisonInfo.innerHTML = '<p class="error">Erreur lors du chargement des cargaisons</p>';
            }
        }

        async function calculatePrice() {
            const poids = parseFloat(document.getElementById('poids').value) || 0;
            const typeProduit = document.getElementById('typeProduit').value;
            const typeCargaison = document.getElementById('typeCargaison').value;
            const nombreColis = parseInt(document.getElementById('nombreColis').value) || 1;
            
            if (!poids || !typeProduit || !typeCargaison) return 0;
            
            // Calcul approximatif selon le tableau (distance moyenne de 100km)
            const distance = 100;
            let prixBase = 0;
            let autresFrais = 0;
            
            switch (typeProduit) {
                case 'alimentaire':
                    switch (typeCargaison) {
                        case 'routiere': prixBase = poids * 100 * distance; break;
                        case 'maritime': prixBase = poids * 90 * distance; autresFrais = 5000; break;
                        case 'aerienne': prixBase = poids * 300 * distance; break;
                    }
                    break;
                case 'chimique':
                    if (typeCargaison === 'maritime') {
                        prixBase = poids * 500;
                        autresFrais = 10000;
                    }
                    break;
                case 'materiel':
                    switch (typeCargaison) {
                        case 'routiere': prixBase = poids * 200 * distance; break;
                        case 'maritime': prixBase = poids * 400 * distance; break;
                        case 'aerienne': prixBase = poids * 1000; break;
                    }
                    break;
            }
            
            const total = (prixBase + autresFrais) * nombreColis;
            return Math.max(total, 10000); // Prix minimum
        }

        // Écouter les changements pour calculer le prix en temps réel
        ['poids', 'typeProduit', 'typeCargaison', 'nombreColis'].forEach(id => {
            document.getElementById(id).addEventListener('change', async () => {
                const prix = await calculatePrice();
                if (prix > 0) {
                    document.getElementById('result').innerHTML = 
                        `<div style="background-color: #d4edda; padding: 10px; border-radius: 4px; margin-top: 15px;">
                            <strong>Prix estimé: ${prix.toLocaleString()} FCFA</strong>
                        </div>`;
                }
            });
        });

        document.getElementById('colisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                expediteur: {
                    nom: formData.get('expNom'),
                    prenom: formData.get('expPrenom'),
                    telephone: formData.get('expTelephone'),
                    adresse: formData.get('expAdresse')
                },
                destinataire: {
                    nomComplet: formData.get('destNom'),
                    telephone: formData.get('destTelephone'),
                    adresse: formData.get('destAdresse')
                },
                poids: parseFloat(formData.get('poids')),
                typeProduit: formData.get('typeProduit'),
                typeCargaison: formData.get('typeCargaison'),
                nombreColis: parseInt(formData.get('nombreColis')),
                cargaisonId: formData.get('cargaisonId')
            };

            // Vérification côté client que la cargaison est sélectionnée
            if (!data.cargaisonId) {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h3>Erreur!</h3>
                        <p>Veuillez obligatoirement sélectionner une cargaison</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/colis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('result').innerHTML = `
                        <div class="success">
                            <h3>Colis créé avec succès!</h3>
                            <p><strong>ID:</strong> ${result.colis.id}</p>
                            <p><strong>Code destinataire:</strong> ${result.colis.codeDestinataire}</p>
                            <p><strong>Prix final:</strong> ${result.colis.prixFinal.toLocaleString()} FCFA</p>
                            <p><strong>Cargaison assignée:</strong> ${result.colis.cargaisonId}</p>
                            <div style="background-color: #f8f9fa; padding: 10px; margin-top: 10px;">
                                <strong>Reçu:</strong><br>
                                <pre style="white-space: pre-wrap;">${result.recu}</pre>
                            </div>
                        </div>
                    `;
                    // Réinitialiser le formulaire
                    e.target.reset();
                    document.getElementById('cargaisonInfo').innerHTML = '';
                } else {
                    document.getElementById('result').innerHTML = `
                        <div class="error">
                            <h3>Erreur!</h3>
                            <p>${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h3>Erreur de connexion!</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
